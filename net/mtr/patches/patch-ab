$NetBSD: patch-ab,v 1.8 2005/02/01 17:02:00 wiz Exp $

--- dns.c.orig	2004-08-26 09:56:53.000000000 +0200
+++ dns.c
@@ -32,9 +32,17 @@
 #include <sys/socket.h>
 #include <netinet/in.h>
 #include <arpa/inet.h>
+#ifdef __APPLE__
+#include <arpa/nameser8_compat.h>
+#else
 #include <arpa/nameser.h>
+#endif
 #include <netdb.h>
+#ifdef __APPLE__
+#include <resolv8_compat.h>
+#else
 #include <resolv.h>
+#endif
 #include <unistd.h>
 #include <fcntl.h>
 #include <ctype.h>
@@ -282,6 +290,17 @@ char nullstring[] = "";
 
 int use_dns = 1;
 
+#ifdef res_ninit
+#define RES_INIT() res_ninit(&myres);
+#define RES_MKQUERY(a, b, c, d, e, f, g, h, i) \
+    res_nmkquery(&myres, a, b, c, d, e, f, g, h, i)
+struct __res_state myres;
+#else
+#define RES_INIT() res_init();
+#define RES_MKQUERY(a, b, c, d, e, f, g, h, i) \
+    res_mkquery(a, b, c, d, e, f, g, h, i)
+#define myres _res
+#endif
 
 /* Code */
 #ifdef CorruptCheck
@@ -448,14 +467,14 @@ void dns_open(void)
 {
   int option,i;
 
-  res_init();
-  if (!_res.nscount) {
+  RES_INIT();
+  if (!myres.nscount) {
     fprintf(stderr,"No nameservers defined.\n");
     exit(-1);
   }
-  _res.options|= RES_RECURSE | RES_DEFNAMES | RES_DNSRCH;
-  for (i = 0;i < _res.nscount;i++)
-    _res.nsaddr_list[i].sin_family = AF_INET;
+  myres.options|= RES_RECURSE | RES_DEFNAMES | RES_DNSRCH;
+  for (i = 0;i < myres.nscount;i++)
+    myres.nsaddr_list[i].sin_family = AF_INET;
   resfd = socket(AF_INET, SOCK_DGRAM, 0);
   if (resfd == -1) {
     fprintf(stderr,"Unable to allocate socket for nameserver communication: %s\n",
@@ -814,17 +833,17 @@ void dorequest(char *s,int type,word id)
 {
   packetheader *hp;
   int r,i;
-  int buf[(MaxPacketsize/sizeof (int))+1];
+  unsigned char buf[MaxPacketsize];
 
-  r = res_mkquery(QUERY,s,C_IN,type,NULL,0,NULL,(unsigned char*)buf,MaxPacketsize);
+  r = RES_MKQUERY(QUERY,s,C_IN,type,NULL,0,NULL,(unsigned char*)buf,MaxPacketsize);
   if (r == -1) {
     restell("Resolver error: Query too large.");
     return;
   }
   hp = (packetheader *)buf;
   hp->id = id;	/* htons() deliberately left out (redundant) */
-  for (i = 0;i < _res.nscount;i++)
-    (void)sendto(resfd,buf,r,0,(struct sockaddr *)&_res.nsaddr_list[i],
+  for (i = 0;i < myres.nscount;i++)
+    (void)sendto(resfd,buf,r,0,(struct sockaddr *)&myres.nsaddr_list[i],
 		 sizeof(struct sockaddr));
 }
 
@@ -1161,15 +1180,15 @@ void dns_ack(void)
   if (r > 0) {
     /* Check to see if this server is actually one we sent to */
     if (from.sin_addr.s_addr == localhost) {
-      for (i = 0;i < _res.nscount;i++)
-	if ((_res.nsaddr_list[i].sin_addr.s_addr == from.sin_addr.s_addr) ||
-	    (!_res.nsaddr_list[i].sin_addr.s_addr))	/* 0.0.0.0 replies as 127.0.0.1 */
+      for (i = 0;i < myres.nscount;i++)
+	if ((myres.nsaddr_list[i].sin_addr.s_addr == from.sin_addr.s_addr) ||
+	    (!myres.nsaddr_list[i].sin_addr.s_addr))	/* 0.0.0.0 replies as 127.0.0.1 */
 	  break;
     } else
-      for (i = 0;i < _res.nscount;i++)
-	if (_res.nsaddr_list[i].sin_addr.s_addr == from.sin_addr.s_addr)
+      for (i = 0;i < myres.nscount;i++)
+	if (myres.nsaddr_list[i].sin_addr.s_addr == from.sin_addr.s_addr)
 	  break;
-    if (i == _res.nscount) {
+    if (i == myres.nscount) {
       sprintf(tempstring,"Resolver error: Received reply from unknown source: %s",
 	      inet_ntoa(from.sin_addr));
       restell(tempstring);
