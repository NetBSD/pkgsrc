#!/bin/sh
#
# hf6to4 - Setup 6to4 IPv6, for NetBSD (and maybe others)
#
# (c) Copyright 2000, 2003 Hubert Feyrer <hubert@feyrer.de>
#

etcdir="/usr/pkg/etc";

not=false
verbose=false

f=$etcdir/hf6to4.conf
if [ -f "$f" ]
then
    . $f
else
    echo "$0: config file $f missing."
    exit 1
fi

###########################################################################
run()
{
    if $not
    then
    	echo "$@"
    else
	if $verbose
	then
	    echo "$@"
	fi
	"$@"
    fi
}

###########################################################################
usage()
{
    echo "Usage: $0 [-n] [-v] {start | stop | rtadvd-start | rtadvd-stop}";
}

###########################################################################
### M A I N
###########################################################################
#
# Process options
#
args=`getopt nvh $*`
if [ $? != 0 ]
then
    usage
    exit 1
fi

set -- $args
while [ $# -gt 0 ]
do
  case "$1" in
  -n)
	not=true
	;;
  -v)
        verbose=true
	;;
  --)
        shift
	break
	;;
  -h)
        usage
	exit 0
	;;
  *)
        usage
	exit 1
	;;
  esac
  shift
done


# maybe ifconfig stf0 create?


#
# Some sanity checks
#
if  [ `ifconfig -a | grep fe80: | wc -l` -le 0 -o \
      `ifconfig -a | grep stf | wc -l` -le 0 ]; then
    echo "$0: It seems your kernel does not support IPv6 or 6to4 (stf)."
    echo "Add 'options INET6' and 'pseudo-device stf 1' to your kernel and retry!";
    exit 1
fi


#
# Figure out IP#s etc.
#
localadr4=`ifconfig $out_if inet \
           | grep inet \
	   | sed 's/^.*inet *//' \
	   | sed 's/ .*$//'`

l4c=`echo $localadr4 | sed 's,\., ,g'`
prefix=`printf "2002:%02x%02x:%02x%02x" $l4c`

localadr6=`printf "$prefix:%04x" $v6_net`


if [ "$peer" = "6to4-anycast" ]
then
    # magic values from rfc 3068
    remoteadr4="192.88.99.1"
    remoteadr6="2002:c058:6301::"
else
    if [ `expr "$remoteadr4" : "^[0-9.]*$"` -gt 0 ]
    then
	$verbose && \
	    echo "IPv4 address of peer given numerically, no resolving needed"
    else
	# Hostname, needs resolving
	
	remoteadr4=`host $peer | sed 's/^.*address //'`

	$verbose && \
	    echo "resolving IPv4 address of peer $peer as $remoteadr4"
    fi

    if [ `expr "$remoteadr6" : "^[0-9a-fA-Z:]*$"` -gt 0 ]
    then
	$verbose && \
	echo "IPv6 address of peer given numerically, no resolving needed"
    else
	remoteadr6=`host -t AAAA $peer | sed 's/^.*address //'`

	$verbose && \
	echo "resolving IPv6 address of peer $peer as $remoteadr6"
    fi
fi


if $verbose
then
    echo "remote v4 address: $remoteadr4"
    echo "local  v4 address: $localadr4"
    echo "remote v6 address: $remoteadr6"
    echo "local  v6 address: $localadr6:$hostbits6"
    echo ""
fi


#
# Handle commands
#

# stop:
if [ "$1" = "stop" ]
then
	run ifconfig stf0 down
	
	# remove all v6 addresses from stf interface:
	adrs=`ifconfig stf0 inet6 \
	      | grep inet6 \
	      | sed -e 's/inet6//' \
	 	    -e 's/prefix.*//g' \
	 	    -e 's/^[ 	]*//' \
		    -e 's/[ 	]*\$//'`
	for adr in $adrs
	do
		run ifconfig stf0 inet6 -alias $adr
	done

	# remove v6 addresses from internal interface
	if [ "$in_if" != "" ]
	then
		adrs=`ifconfig $in_if inet6 \
		      | grep inet6 \
		      | grep "2002:.*:$v6_innernet:$hostbits6" \
		      | sed -e 's/inet6//' \
			    -e 's/prefix.*//g' \
			    -e 's/^[ 	]*//' \
			    -e 's/[ 	]*\$//'`
		for adr in $adrs
		do
			run ifconfig $in_if inet6 -alias $adr
		done
	fi

	# remove default route:
	run route delete -inet6 default
fi


# start:
if [ "$1" = "start" ]
then
	run ifconfig stf0 inet6 $localadr6:$hostbits6 prefixlen $v6_prefixlen alias
	run route add -inet6 default $remoteadr6 >/dev/null
	if [ "$in_if" != "" ]
	then
	    run ifconfig $in_if inet6 $prefix:$v6_innernet:$hostbits6
	fi
fi

# rtadvd-stop:
#
# XXX maybe better do this via rc.conf & rc.d/rtadvd?
if [ "$1" = "rtadvd-stop" -o "$1" = "stop-rtadvd" ]
then
    if [ -f "/var/run/rtadvd.pid" ]
    then
	pid=`cat /var/run/rtadvd.pid`
	run kill -TERM $pid
	run rm -f /var/run/rtadvd.pid
    else
	echo $0: no rtadvd running!
    fi
fi

# rtadvd-start:
#
# XXX maybe better do this via rc.conf & rc.d/rtadvd?
if [ "$1" = "rtadvd-start" -o "$1" = "start-rtadvd" ]
then
    if [ -f "/var/run/rtadvd.pid" ]
    then
	echo $0: rtadvd already running!
    else
	run sysctl -w net.inet6.ip6.forwarding=1
	run sysctl -w net.inet6.ip6.accept_rtadv=0
	run rtadvd $in_if
    fi
fi
