#!/usr/bin/perl
#

eval '(exit $?0)' && eval 'exec /usr/bin/perl -S $0 ${1+"$@"}'
& eval 'exec /usr/bin/perl -S $0 $argv:q'
if 0;

if( $> ) {
	print "\nYou must be root to run this step!\n\n";
	exit 1;
} 

@ARGV = "pgsql" unless @ARGV;

$pgsql = $ARGV[0];

if( getpwnam( $pgsql ) ) {
	( $null, $null, $pgUID ) = getpwnam( $pgsql );
	$addname = 0;
} else {
	$pgUID = 70;
	while( getpwuid( $pgUID ) ) {
		$pgUID++;
	}
	$addname = 1;
}

if( getgrnam( $pgsql ) ) {
	( $null, $null, $pgGID ) = getgrnam( $pgsql );
} else {
	$pgGID = 70;
	while( getgrgid( $pgGID ) ) {
		$pgGID++;
	}
	&append_file( "/etc/group", "${pgsql}:*:${pgGID}:" );
}

print "pgsql user $pgsql using uid $pgUID\n";
print "pgsql user $pgsql using gid $pgGID\n";

if ($addname) {
	system( "/usr/bin/chpass -l -a \"$pgsql:*************:${pgUID}:${pgGID}::0:0:PostgreSQL pseudo-user:$ENV{'PREFIX'}/$pgsql:/bin/sh\"" );
}

sub append_file {
	local($file,@list) = @_;
	local($LOCK_EX) = 2;
	local($LOCK_NB) = 4;
	local($LOCK_UN) = 8;

	open(F, ">> $file") || die "$file: $!\n";
	while( ! flock( F, $LOCK_EX | $LOCK_NB ) ) {
		exit 1;
	}
	print F join( "\n", @list) . "\n";
	close F;
	flock( F, $LOCK_UN );
}
