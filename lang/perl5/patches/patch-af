$NetBSD: patch-af,v 1.4 1998/12/02 02:28:30 tv Exp $

--- hints/netbsd.sh.orig	Thu May  8 11:52:59 1997
+++ hints/netbsd.sh	Tue Dec  1 20:41:28 1998
@@ -1,12 +1,11 @@
 # hints/netbsd.sh
 #
-# talk to mrg@eterna.com.au if you want to change this file.
+# talk to packages@netbsd.org if you want to change this file.
 #
 # netbsd keeps dynamic loading dl*() functions in /usr/lib/crt0.o,
 # so Configure doesn't find them (unless you abandon the nm scan).
 # this should be *just* 0.9 below as netbsd 0.9a was the first to
-# introduce shared libraries.  however, they don't work/build on
-# pmax, powerpc and alpha ports correctly, yet.
+# introduce shared libraries.
 
 case "$archname" in
 '')
@@ -19,26 +18,26 @@
 	usedl="$undef"
 	;;
 *)
-	case `uname -m` in
-	alpha|powerpc|pmax)
+	if [ -f /usr/libexec/ld.elf_so ]; then
+		d_dlopen=$define
+		d_dlerror=$define
+		ccdlflags="-Wl,-E -Wl,-R${PREFIX}/lib $ccdlflags"
+		cccdlflags="-DPIC -fPIC $cccdlflags"
+		lddlflags="--whole-archive -shared $lddlflags"
+	elif [ "`uname -m`" = "pmax" ]; then
+# NetBSD 1.3 and 1.3.1 on pmax shipped an `old' ld.so, which will not work.
 		d_dlopen=$undef
-		;;
-# this doesn't work (yet).
-#	alpha)
-#		d_dlopen=$define
-#		d_dlerror=$define
-#		cccdlflags="-DPIC -fPIC $cccdlflags"
-#		lddlflags="-shared $lddlflags"
-#		;;
-	*)
+	elif [ -f /usr/libexec/ld.so ]; then
 		d_dlopen=$define
 		d_dlerror=$define
+		ccdlflags="-Wl,-R${PREFIX}/lib $ccdlflags"
 # we use -fPIC here because -fpic is *NOT* enough for some of the
 # extensions like Tk on some netbsd platforms (the sparc is one)
 		cccdlflags="-DPIC -fPIC $cccdlflags"
 		lddlflags="-Bforcearchive -Bshareable $lddlflags"
-		;;
-	esac
+	else
+		d_dlopen=$undef
+	fi
 	;;
 esac
 
@@ -47,13 +46,26 @@
 # way to make perl call setuid() or setgid().  if they aren't, then
 # ($<, $>) = ($u, $u); will work (same for $(/$)).  this is because
 # you can not change the real userid of a process under 4.4BSD.
-# netbsd fixed this in 1.2A.
+# netbsd fixed this in 1.3.2.
 case "$osvers" in
-0.9*|1.0*|1.1*|1.2_*|1.2|1.2.*)
+0.9*|1.[012]*|1.3|1.3.1)
 	d_setregid="$undef"
 	d_setreuid="$undef"
 	d_setrgid="$undef"
 	d_setruid="$undef"
+	;;
+esac
+
+# there's no problem with vfork.
+d_vfork=true
+
+# in case the user installs a shared libperl, with or without the static lib,
+# give us a "rpath" for third party binary builds:
+case "$osvers" in
+0*|1.[01]*)
+	;;
+*)
+	ccdlflags="-Wl,-R$archlibexp/CORE $ccdlflags"
 	;;
 esac
 
