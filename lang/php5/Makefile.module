# $NetBSD: Makefile.module,v 1.1.1.1 2004/10/29 20:31:54 jdolecek Exp $

.include "../../wip/php5/Makefile.common"

PKGNAME?=		php-${MODNAME}-${PHP5_VERSION}
PKGREVISION?=		# empty

.include "../../mk/automake.mk"

PKGMODNAME?=		${MODNAME:S/-/_/}
MODULESDIR?=		${WRKSRC}/modules
PLIST_SUBST+=		MODNAME=${PKGMODNAME}

EXTRACT_ELEMENTS?=	${DISTNAME}/ext/${PKGMODNAME}
WRKSRC?=		${WRKDIR}/${EXTRACT_ELEMENTS}
DISTINFO_FILE?=		${PKGDIR}/../../wip/php5/distinfo

PHPIZE?=		${BUILDLINK_PREFIX.php}/bin/phpize
PHP_CONFIG?=		${BUILDLINK_PREFIX.php}/bin/php-config

GNU_CONFIGURE=		YES
CONFIGURE_ARGS+=	--with-php-config=${PHP_CONFIG}

USE_CONFIG_WRAPPER=	YES
USE_LIBTOOL=		YES

# Ensure we export symbols in the linked shared object.
LDFLAGS+=		${EXPORT_SYMBOLS_LDFLAGS}
MAKE_ENV+=		EXPORT_SYMBOLS_LDFLAGS="${EXPORT_SYMBOLS_LDFLAGS}"

PLIST_SRC=		${.CURDIR}/../../wip/php5/PLIST.module
MESSAGE_SRC=		${.CURDIR}/../../wip/php5/MESSAGE.module
MESSAGE_SUBST+=		MODNAME=${PKGMODNAME}
MESSAGE_SUBST+=		PHP_EXTENSION_DIR=${PHP_EXTENSION_DIR}

pre-configure:	phpize-module

phpize-module:
	@cookie=${WRKDIR}/.phpize_module_done;				\
	if [ ! -f $${cookie} ]; then					\
		cd ${WRKSRC} &&						\
		${SETENV} AUTOCONF=${AUTOCONF} AUTOHEADER=${AUTOHEADER}	\
		    ACLOCAL=${ACLOCAL}					\
		    LIBTOOLIZE=${LOCALBASE}/bin/libtoolize		\
		    ${PHPIZE} &&					\
		${TOUCH} ${TOUCH_FLAGS} $${cookie};			\
	fi

do-install:	do-module-install

do-module-install:
	${INSTALL_DATA_DIR} ${PREFIX}/${PHP_EXTENSION_DIR}
	${INSTALL_DATA} ${MODULESDIR}/${PKGMODNAME}.so	\
	    ${PREFIX}/${PHP_EXTENSION_DIR}

.include "../../wip/php5/buildlink3.mk"
