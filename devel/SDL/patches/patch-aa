$NetBSD: patch-aa,v 1.7 2004/06/22 09:10:12 dillo Exp $

--- src/joystick/bsd/SDL_sysjoystick.c.orig	2004-02-18 18:22:01.000000000 +0100
+++ src/joystick/bsd/SDL_sysjoystick.c
@@ -238,6 +238,7 @@ SDL_SYS_JoystickOpen(SDL_Joystick *joy)
 	struct hid_data *hdata;
 	struct report *rep;
 	int fd;
+	int i;
 
 	fd = open(path, O_RDONLY);
 	if (fd == -1) {
@@ -302,6 +303,8 @@ SDL_SYS_JoystickOpen(SDL_Joystick *joy)
 	joy->nbuttons = 0;
 	joy->nhats = 0;
 	joy->nballs = 0;
+	for (i=0; i<JOYAXE_count; i++)
+		hw->axis_map[i] = -1;
 
 	while (hid_get_item(hdata, &hitem) > 0) {
 		char *sp;
@@ -328,8 +331,7 @@ SDL_SYS_JoystickOpen(SDL_Joystick *joy)
 			    unsigned usage = HID_USAGE(hitem.usage);
 			    int joyaxe = usage_to_joyaxe(usage);
 			    if (joyaxe >= 0) {
-				hw->axis_map[joyaxe] = joy->naxes;
-				joy->naxes++;
+				hw->axis_map[joyaxe] = 1;
 			    } else if (usage == HUG_HAT_SWITCH) {
 				joy->nhats++;
 			    }
@@ -347,6 +349,9 @@ SDL_SYS_JoystickOpen(SDL_Joystick *joy)
 		}
 	}
 	hid_end_parse(hdata);
+	for (i=0; i<JOYAXE_count; i++)
+		if (hw->axis_map[i] > 0)
+			hw->axis_map[i] = joy->naxes++;
 
 usbend:
 	/* The poll blocks the event thread. */
@@ -456,7 +461,8 @@ SDL_SYS_JoystickUpdate(SDL_Joystick *joy
 			    } else if (usage == HUG_HAT_SWITCH) {
 				v = (Sint32)hid_get_data(REP_BUF_DATA(rep),
 							 &hitem);
-				SDL_PrivateJoystickHat(joy, 0, hatval_to_sdl(v));
+				SDL_PrivateJoystickHat(joy, 0,
+					hatval_to_sdl(v)-hitem.logical_minimum);
 			    }
 			    break;
 			}
@@ -529,9 +535,9 @@ report_alloc(struct report *r, struct re
 #endif
 #else
 # ifdef USBHID_NEW
-	len = hid_report_size(rd, repinfo[repind].kind, &r->rid);
-# else
 	len = hid_report_size(rd, repinfo[repind].kind, r->rid);
+# else
+	len = hid_report_size(rd, repinfo[repind].kind, &r->rid);
 # endif
 #endif
 
