$NetBSD: patch-ab,v 1.7 2000/06/05 01:13:35 hubertf Exp $

--- Makefile.common.orig	Thu Jun  1 19:38:14 2000
+++ Makefile.common	Mon Jun  5 01:38:40 2000
@@ -67,7 +67,7 @@
 $(OBJECTS): %.o: %.c
 	$(CC) -c $(CFLAGS) $(INCLUDE) -o $@ $<
 
-LIBOPT = $(SRCDIR)/libopt
+LIBOPT = /bin/echo		# XXX must exist, can't be ${ECHO} (shell builtin)
 
 # Rules for conventional single-object file executables
 $(PORTBINARIES): %: %.o $(NETPBMLIBS) $(LIBOPT)
@@ -97,7 +97,7 @@
 # BUILDING NETPBM LIBRARIES
 
 $(LIBOBJECTS): %.o: %.c
-	$(CC) -c $(CFLAGS) $(CFLAGS_SHLIB) $(INCLUDE) -o $@ $<
+	$(LIBTOOL) $(CC) -c $(CFLAGS) $(CFLAGS_SHLIB) $(INCLUDE) $<
 
 SONAME = lib$(LIBROOT).so.$(MAJ)
 
@@ -117,10 +117,8 @@
           `$(LIBOPT) $(LIBLIBS)` -lc
 
 # Static library.  Unused by default, but with a small change to make files...
-lib$(LIBROOT).a: $(LIBOBJECTS) $(LIBOBJECTS_X)
-	-rm -f $@
-	ar rc $@ $(LIBOBJECTS) $(LIBOBJECTS_X)
-	-ranlib $@
+lib$(LIBROOT).la: $(LIBOBJECTS) $(LIBOBJECTS_X)
+	$(LIBTOOL) --mode=link $(CC) -rpath $(PREFIX)/lib -version-info $(MAJ):$(MIN) -o $@ $(LIBOBJECTS:.o=.lo) $(LIBOBJECTS_X:.o=.lo)
 
 # Some maintenance notes about $(INSTALL):  Some install programs can install
 # multiple files in one shot; others can take only one file at a time.  Some
@@ -157,7 +155,7 @@
 # Make and Install know that pbmmake.exe counts as pbmmake.
 	for x in $(BINARIES); \
 	do \
-	   $(INSTALL) -c -s -m $(INSTALL_PERM_BIN) $$x $(INSTALLBINARIES); \
+	   $(LIBTOOL) --mode=install $(INSTALL) -c -s -m $(INSTALL_PERM_BIN) $$x $(INSTALLBINARIES); \
 	done
 
 .PHONY: install.script
@@ -208,8 +206,8 @@
 # built.  If a previous make STATICLIB=N didn't build the static
 # library, the dependency here will do that.
 .PHONY: install.staticlib
-install.staticlib: lib$(LIBROOT).a
-	$(INSTALL) -c -m $(INSTALL_PERM_LIBS) $< $(INSTALLLIBS)/$<
+install.staticlib: lib$(LIBROOT).la
+	$(LIBTOOL) --mode=install $(BSD_INSTALL_DATA) lib$(LIBROOT).la $(PREFIX)/lib
 
 .PHONY: install.lib.common
 ifeq ($(NETPBMLIBSUFFIX),so)
@@ -223,7 +221,7 @@
 
 .PHONY: clean.common
 clean.common:
-	-rm -f *.o *.o2 *.a *.so* *.cat *~ core *.core *.i *.s merge.h \
+	-rm -f *.o *.o2 *.la *.so* *.cat *~ core *.core *.i *.s merge.h \
           $(BINARIES) $(MERGENAME)
 
 .PHONY: dep
