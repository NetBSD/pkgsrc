# start of deinstall
#
# $NetBSD: deinstall,v 1.32 2005/02/02 10:33:01 jlam Exp $

case ${STAGE} in
VIEW-DEINSTALL)
	case ${_PKG_CONFIG} in
	YES)
		case ${PKG_SYSCONFDEPOTBASE} in
		"")
			${TEST} -x ./+FILES &&
				./+FILES VIEW-REMOVE ${PREFIX} ${PKG_PREFIX}
			;;
		*)
			${SETENV} PLIST_IGNORE_FILES="${CONF_IGNORE_FILES}" \
				${LINKFARM} -D -t ${PKG_SYSCONFVIEWBASE} -d ${PKG_SYSCONFDEPOTBASE} ${PKGNAME}
			${RMDIR} -p ${PKG_SYSCONFVIEWBASE} 2>/dev/null || ${TRUE}
			;;
		esac
		;;
	esac
	if [ -n "${PKG_SHELL}" -a "${PKG_REGISTER_SHELLS}" = "YES" ]; then
		${ECHO} "===> Updating /etc/shells"
		${CP} /etc/shells /etc/shells.pkgsrc."$$"
		(${GREP} -v "^${PKG_SHELL}" /etc/shells.pkgsrc."$$" || ${TRUE}) > /etc/shells
		${RM} /etc/shells.pkgsrc."$$"
	fi
	;;

DEINSTALL)
	# Remove configuration files if they don't differ from the default
	# config file.
	#
	case ${_PKG_CONFIG} in
	YES)	${TEST} -x ./+FILES &&
			./+FILES REMOVE ${PKG_METADATA_DIR} ;;
	esac
	case ${_PKG_CONFIG}${_PKG_RCD_SCRIPTS} in
	YESYES)	${TEST} -x ./+RCD_SCRIPTS &&
			./+RCD_SCRIPTS REMOVE ${PKG_METADATA_DIR} ;;
	esac
	;;

POST-DEINSTALL)
	if [ "${PKG_INSTALLATION_TYPE}" = "pkgviews" -a			\
	     "${_PKG_CONFIG}" = "YES" -a -n "${CONF_DEPENDS}" ]; then
		if [ -h ${PKG_SYSCONFDIR} ]; then
			${RM} -f ${PKG_SYSCONFDIR}
		fi
		${RMDIR} -p `${DIRNAME} ${PKG_SYSCONFDIR}` 2>/dev/null || ${TRUE}
	fi
	#
	# Remove empty directories and unused users/groups.
	#
	case ${_PKG_CONFIG} in
	YES)	${TEST} -x ./+DIRS &&
			./+DIRS REMOVE ${PKG_METADATA_DIR} ;;
	esac
	case ${_PKG_CREATE_USERGROUP} in
	YES)	${TEST} -x ./+USERGROUP &&
			./+USERGROUP REMOVE ${PKG_METADATA_DIR} ;;
	esac
	#
	# Check for any existing bits after we're finished de-installing.
	#
	${TEST} -x ./+USERGROUP &&
		./+USERGROUP CHECK-REMOVE ${PKG_METADATA_DIR}
	${TEST} -x ./+FILES &&
		./+FILES CHECK-REMOVE ${PKG_METADATA_DIR}
	${TEST} -x ./+RCD_SCRIPTS &&
		./+RCD_SCRIPTS CHECK-REMOVE ${PKG_METADATA_DIR}
	${TEST} -x ./+DIRS &&
		./+DIRS CHECK-REMOVE ${PKG_METADATA_DIR}
	;;
esac

# end of deinstall
